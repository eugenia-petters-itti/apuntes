# üèóÔ∏è DBA Training System - Infraestructura Terraform Completa

## üìã Descripci√≥n General

Esta carpeta contiene la infraestructura completa como c√≥digo (IaC) para el **Sistema de Entrenamiento DBA**, dise√±ada para soportar 15 escenarios de diagn√≥stico across MySQL, PostgreSQL, y MongoDB con un enfoque h√≠brido OnPrem + Cloud.

## üéØ Caracter√≠sticas Principales

- **Infraestructura Modular**: M√≥dulos Terraform reutilizables y mantenibles
- **Seguridad Integrada**: Security groups, IAM roles, y encriptaci√≥n por defecto
- **Monitoreo Completo**: Grafana, Prometheus, CloudWatch integrados
- **Automatizaci√≥n**: Scripts de configuraci√≥n y validaci√≥n automatizados
- **Escalabilidad**: Soporte para hasta 100 estudiantes concurrentes
- **Optimizaci√≥n de Costos**: Configuraciones optimizadas para entrenamiento

## üìÅ Estructura de Archivos

```
05-terraform/
‚îú‚îÄ‚îÄ main.tf                     # Configuraci√≥n principal y m√≥dulos
‚îú‚îÄ‚îÄ variables.tf                # Variables de configuraci√≥n
‚îú‚îÄ‚îÄ outputs.tf                  # Outputs de infraestructura
‚îú‚îÄ‚îÄ security-groups.tf          # Grupos de seguridad
‚îú‚îÄ‚îÄ iam.tf                      # Roles y pol√≠ticas IAM
‚îú‚îÄ‚îÄ modules.tf                  # Definici√≥n de m√≥dulos
‚îú‚îÄ‚îÄ terraform.tfvars.example    # Ejemplo de variables
‚îú‚îÄ‚îÄ DEPLOYMENT-GUIDE.md         # Gu√≠a completa de despliegue
‚îú‚îÄ‚îÄ validate-deployment.sh      # Script de validaci√≥n
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ bastion/               # M√≥dulo del host bastion
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ userdata.sh        # Script de configuraci√≥n avanzado
‚îÇ   ‚îú‚îÄ‚îÄ documentdb/            # M√≥dulo DocumentDB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf
‚îÇ   ‚îú‚îÄ‚îÄ student-environments/   # M√≥dulo entornos estudiantes
‚îÇ   ‚îú‚îÄ‚îÄ monitoring/            # M√≥dulo monitoreo
‚îÇ   ‚îî‚îÄ‚îÄ automation/            # M√≥dulo automatizaci√≥n
‚îî‚îÄ‚îÄ lab_infrastructure.tf      # Configuraci√≥n legacy (mantener)
```

## üöÄ Recursos Desplegados

### **Infraestructura de Red**
- **VPC**: Red privada virtual con subnets p√∫blicas, privadas y de base de datos
- **Security Groups**: Configuraci√≥n granular de acceso por servicio
- **NAT Gateway**: Acceso a internet para subnets privadas
- **VPC Endpoints**: Acceso seguro a servicios AWS

### **Bases de Datos**
```hcl
# MySQL RDS
- Engine: MySQL 8.0
- Instance: db.t3.micro (configurable)
- Storage: 20GB con auto-scaling hasta 100GB
- Backup: 7 d√≠as (configurable)
- Performance Insights: Habilitado
- Enhanced Monitoring: Habilitado

# PostgreSQL RDS  
- Engine: PostgreSQL 15.4
- Instance: db.t3.micro (configurable)
- Storage: 20GB con auto-scaling hasta 100GB
- Backup: 7 d√≠as (configurable)
- Performance Insights: Habilitado
- Enhanced Monitoring: Habilitado

# DocumentDB Cluster
- Engine: DocumentDB 5.0
- Instance: db.t3.medium (configurable)
- Cluster Size: 1-16 instancias
- Backup: 5 d√≠as (configurable)
- Audit Logs: Habilitado
- Profiler: Habilitado
```

### **Compute y Aplicaciones**
```hcl
# Bastion Host
- Instance: t3.medium
- OS: Amazon Linux 2
- Tools: Grafana, Prometheus, Jupyter, Database clients
- Storage: 50GB EBS encriptado
- Public IP: Elastic IP asignada

# Student Environments (Opcional)
- Auto Scaling Group
- Instance: t3.small
- Max Students: 20 (configurable hasta 100)
- Private Subnets: Acceso v√≠a bastion
```

### **Monitoreo y Observabilidad**
```hcl
# Grafana Dashboard
- Port: 3000
- Credentials: admin/dba-training-2024
- Dashboards: Pre-configurados para DBA scenarios

# Prometheus Metrics
- Port: 9090  
- Exporters: Node, MySQL, PostgreSQL, MongoDB
- Retention: 15 d√≠as

# CloudWatch Integration
- Log Groups: Centralizados por servicio
- Alarms: CPU, Memory, Connections, Storage
- Retention: 14 d√≠as (configurable)

# Jupyter Notebooks
- Port: 8888
- Token: dba-training-2024
- Environment: Python 3 con librer√≠as DBA
```

## ‚öôÔ∏è Configuraci√≥n y Despliegue

### **1. Prerrequisitos**
```bash
# Software requerido
terraform --version  # >= 1.0
aws --version        # >= 2.0
git --version

# Configuraci√≥n AWS
aws configure
aws sts get-caller-identity

# Key Pair (debe existir en AWS)
aws ec2 describe-key-pairs --key-names your-key-name
```

### **2. Configuraci√≥n de Variables**
```bash
# Copiar archivo de ejemplo
cp terraform.tfvars.example terraform.tfvars

# Editar variables cr√≠ticas
vim terraform.tfvars
```

**Variables Cr√≠ticas:**
```hcl
# terraform.tfvars
key_name = "your-existing-key-pair"  # OBLIGATORIO
aws_region = "us-east-1"
environment = "training"
max_students = 20

# Seguridad - IMPORTANTE: Restringir en producci√≥n
allowed_cidr_blocks = ["your.ip.address/32"]

# Configuraci√≥n de instancias
bastion_instance_type = "t3.medium"
db_instance_class = "db.t3.micro"
```

### **3. Despliegue Paso a Paso**
```bash
# 1. Inicializar Terraform
terraform init

# 2. Validar configuraci√≥n
terraform validate

# 3. Revisar plan de despliegue
terraform plan

# 4. Aplicar configuraci√≥n (15-20 minutos)
terraform apply

# 5. Validar despliegue
./validate-deployment.sh
```

## üìä Informaci√≥n de Acceso

### **Outputs Principales**
```bash
# Ver todos los outputs
terraform output

# Informaci√≥n espec√≠fica
terraform output bastion_public_ip
terraform output web_access_urls
terraform output database_credentials  # Sensible
```

### **URLs de Acceso**
```bash
# Obtener IP del bastion
BASTION_IP=$(terraform output -raw bastion_public_ip)

# URLs principales
echo "Training Portal: http://$BASTION_IP"
echo "Grafana: http://$BASTION_IP:3000"
echo "Prometheus: http://$BASTION_IP:9090"  
echo "Jupyter: http://$BASTION_IP:8888"
```

### **Conexi√≥n SSH**
```bash
# Conectar al bastion
ssh -i your-key.pem ec2-user@$BASTION_IP

# Scripts de conexi√≥n a bases de datos (desde bastion)
/opt/dba-training/scripts/connect-mysql.sh
/opt/dba-training/scripts/connect-postgres.sh
/opt/dba-training/scripts/connect-mongodb.sh
```

## üîß Herramientas y Utilidades

### **Bastion Host - Herramientas Preinstaladas**
```bash
# Clientes de base de datos
- mysql (MySQL 8.0 client)
- psql (PostgreSQL 15 client)  
- mongosh (MongoDB Shell 7.0)

# Herramientas de monitoreo
- Grafana 10.x
- Prometheus 2.45
- Node Exporter
- Database Exporters (MySQL, PostgreSQL, MongoDB)

# Herramientas de desarrollo
- Python 3 + pip
- Jupyter Notebook
- Docker + Docker Compose
- Git, vim, htop, curl, wget

# Librer√≠as Python para DBA
- pymysql, psycopg2-binary, pymongo
- pandas, numpy, matplotlib
- sqlalchemy, boto3, awscli
```

### **Scripts de Automatizaci√≥n**
```bash
# En el bastion host
dba-status          # Verificar estado de servicios
dba-start           # Iniciar todos los servicios
monitoring-dashboard.py  # Dashboard web personalizado

# Directorios importantes
/opt/dba-training/scripts/    # Scripts de conexi√≥n
/opt/dba-training/scenarios/  # 15 escenarios de diagn√≥stico
/opt/dba-training/datasets/   # Datasets de entrenamiento
/opt/dba-training/logs/       # Logs del sistema
```

## üéì Escenarios de Entrenamiento

### **MySQL Scenarios (5)**
1. **mysql-deadlock**: Detecci√≥n y resoluci√≥n de deadlocks
2. **mysql-performance**: Optimizaci√≥n de queries lentas
3. **mysql-replication**: Configuraci√≥n y troubleshooting de replicaci√≥n
4. **mysql-backup-recovery**: Estrategias de backup y recovery
5. **mysql-connection-exhaustion**: Gesti√≥n de conexiones

### **PostgreSQL Scenarios (5)**
1. **postgres-vacuum**: Optimizaci√≥n de VACUUM y ANALYZE
2. **postgres-index-bloat**: Detecci√≥n y correcci√≥n de index bloat
3. **postgres-connection-pooling**: Configuraci√≥n de connection pooling
4. **postgres-query-optimization**: An√°lisis y optimizaci√≥n de queries
5. **postgres-partition-management**: Gesti√≥n de particiones

### **MongoDB Scenarios (5)**
1. **mongodb-sharding**: Configuraci√≥n y balanceo de sharding
2. **mongodb-replica-set**: Gesti√≥n de replica sets
3. **mongodb-performance**: Optimizaci√≥n de performance
4. **mongodb-aggregation**: Pipelines de agregaci√≥n complejos
5. **mongodb-index-optimization**: Estrategias de indexaci√≥n

## üí∞ Estimaci√≥n de Costos

### **Configuraci√≥n Est√°ndar (Mensual)**
```bash
# Compute
Bastion t3.medium (24/7):        ~$30
Student environments (variable): ~$0-50

# Databases  
MySQL db.t3.micro:              ~$15
PostgreSQL db.t3.micro:         ~$15
DocumentDB db.t3.medium:        ~$50

# Network
NAT Gateway:                    ~$45
Data Transfer:                  ~$5

# Storage
EBS (100GB total):              ~$10
Backup storage:                 ~$5

# Monitoring
CloudWatch logs/metrics:        ~$5

Total Estimado:                 ~$180/mes
```

### **Optimizaciones de Costo**
```hcl
# Para entornos de desarrollo
enable_spot_instances = true      # -30% en compute
auto_shutdown_schedule = "0 22 * * *"  # Apagar por las noches

# Para laboratorios cortos
db_backup_retention_period = 1   # M√≠nimo backup
enable_deletion_protection = false

# Para grupos peque√±os
max_students = 10                # Reduce auto-scaling
db_instance_class = "db.t3.micro"  # Instancias m√°s peque√±as
```

## üîç Monitoreo y Alertas

### **CloudWatch Alarms Configuradas**
```bash
# Database Performance
- CPU Utilization > 80%
- Database Connections > 80% of max
- Free Storage Space < 20%
- Read/Write Latency > 200ms

# System Performance  
- Bastion CPU > 80%
- Memory Usage > 85%
- Disk Usage > 90%

# Application Health
- Service Down alerts
- Failed Login attempts
- Error Rate > 5%
```

### **Grafana Dashboards**
```bash
# Pre-configurados
1. DBA System Overview
2. MySQL Performance Dashboard  
3. PostgreSQL Performance Dashboard
4. MongoDB Performance Dashboard
5. Infrastructure Monitoring
6. Student Activity Dashboard
```

## üõ†Ô∏è Mantenimiento y Troubleshooting

### **Comandos de Diagn√≥stico**
```bash
# Validar despliegue completo
./validate-deployment.sh

# Verificar estado de servicios
ssh -i key.pem ec2-user@$BASTION_IP "dba-status"

# Ver logs del sistema
ssh -i key.pem ec2-user@$BASTION_IP "sudo journalctl -f"

# Verificar conectividad de bases de datos
terraform output troubleshooting_commands
```

### **Problemas Comunes y Soluciones**

#### **1. Error de Key Pair**
```bash
Error: InvalidKeyPair.NotFound

# Soluci√≥n
aws ec2 describe-key-pairs --region your-region
# Crear key pair si no existe o actualizar variable
```

#### **2. Servicios no iniciados en Bastion**
```bash
# Conectar y verificar
ssh -i key.pem ec2-user@$BASTION_IP
sudo systemctl status prometheus grafana-server

# Reiniciar si es necesario
sudo systemctl restart prometheus grafana-server
dba-start
```

#### **3. Problemas de conectividad de base de datos**
```bash
# Verificar security groups
aws ec2 describe-security-groups --filters "Name=tag:Project,Values=dba-training-system"

# Test de conectividad
telnet $MYSQL_ENDPOINT 3306
telnet $POSTGRES_ENDPOINT 5432
telnet $DOCUMENTDB_ENDPOINT 27017
```

### **Logs Importantes**
```bash
# Configuraci√≥n inicial del bastion
/var/log/user-data.log

# Logs de aplicaciones DBA
/opt/dba-training/logs/*.log

# Logs de servicios
sudo journalctl -u prometheus
sudo journalctl -u grafana-server
```

## üîÑ Actualizaciones y Cleanup

### **Actualizar Configuraci√≥n**
```bash
# Modificar variables
vim terraform.tfvars

# Aplicar cambios
terraform plan
terraform apply
```

### **Cleanup Completo**
```bash
# ADVERTENCIA: Elimina toda la infraestructura
terraform destroy

# Confirmar con 'yes'
# Tiempo estimado: 10-15 minutos
```

### **Cleanup Selectivo**
```bash
# Eliminar solo bases de datos
terraform destroy -target=module.rds_mysql
terraform destroy -target=module.rds_postgres  
terraform destroy -target=module.documentdb
```

## üìû Soporte y Documentaci√≥n

### **Documentaci√≥n Adicional**
- **DEPLOYMENT-GUIDE.md**: Gu√≠a detallada de despliegue
- **validate-deployment.sh**: Script de validaci√≥n automatizada
- **terraform.tfvars.example**: Configuraci√≥n de ejemplo completa

### **Estructura de Soporte**
```bash
# Generar reporte de estado
terraform output > system-status.txt
./validate-deployment.sh > validation-report.txt

# Informaci√≥n para soporte
- Terraform version
- AWS CLI version  
- Region y account ID
- Logs de error espec√≠ficos
```

---

## üéØ Pr√≥ximos Pasos

1. **Revisar DEPLOYMENT-GUIDE.md** para instrucciones detalladas
2. **Configurar terraform.tfvars** con tus valores espec√≠ficos
3. **Ejecutar despliegue** siguiendo los pasos documentados
4. **Validar sistema** con el script de validaci√≥n
5. **Configurar acceso de estudiantes** y comenzar entrenamiento

**¬°Tu sistema de entrenamiento DBA est√° listo para transformar la educaci√≥n en administraci√≥n de bases de datos!** üöÄ
