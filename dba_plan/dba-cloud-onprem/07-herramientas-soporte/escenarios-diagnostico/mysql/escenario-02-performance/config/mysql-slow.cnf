# Configuración MySQL Subóptima para Escenario de Performance
# Archivo: config/mysql-slow.cnf

[mysqld]
# === CONFIGURACIÓN BÁSICA ===
server-id = 1
bind-address = 0.0.0.0
port = 3306

# === CONFIGURACIÓN PROBLEMÁTICA DE PERFORMANCE ===
# PROBLEMA: Buffer pool muy pequeño
innodb_buffer_pool_size = 128M          # MUY PEQUEÑO - debería ser 70% de RAM
innodb_buffer_pool_instances = 1        # SUBÓPTIMO - debería ser 8

# PROBLEMA: Configuración de memoria insuficiente
key_buffer_size = 32M                   # PEQUEÑO para MyISAM
sort_buffer_size = 256K                 # PEQUEÑO para ORDER BY
read_buffer_size = 128K                 # PEQUEÑO para table scans
read_rnd_buffer_size = 256K             # PEQUEÑO para ORDER BY
join_buffer_size = 256K                 # PEQUEÑO para JOINs
tmp_table_size = 16M                    # PEQUEÑO para temp tables
max_heap_table_size = 16M               # PEQUEÑO para MEMORY tables

# PROBLEMA: Query cache deshabilitado (MySQL 5.7)
# query_cache_type = 0
# query_cache_size = 0

# PROBLEMA: Configuración de InnoDB subóptima
innodb_log_file_size = 48M              # PEQUEÑO - debería ser 256M+
innodb_log_buffer_size = 8M             # PEQUEÑO - debería ser 16M+
innodb_flush_log_at_trx_commit = 1      # SEGURO pero lento
innodb_flush_method = O_DIRECT          # OK pero podría optimizarse
innodb_file_per_table = 1               # OK
innodb_open_files = 300                 # BAJO - debería ser mayor

# === CONFIGURACIÓN DE LOGGING ===
log_destination = 'stderr,csvlog'
logging_collector = on
log_directory = '/var/log/mysql'
log_filename = 'mysql-%Y-%m-%d.log'

# Logging para diagnóstico
general_log = 1
general_log_file = /var/log/mysql/general.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1                     # Capturar queries >1 segundo
log_queries_not_using_indexes = 1       # Capturar queries sin índices
min_examined_row_limit = 100            # Solo queries que examinan >100 filas

# === CONFIGURACIÓN DE CONEXIONES ===
max_connections = 100                   # OK para el escenario
max_connect_errors = 1000
connect_timeout = 60
wait_timeout = 28800
interactive_timeout = 28800

# === CONFIGURACIÓN DE THREADS ===
thread_cache_size = 8                   # PEQUEÑO - debería ser mayor
thread_stack = 256K                     # OK

# === CONFIGURACIÓN DE TABLAS ===
table_open_cache = 400                  # PEQUEÑO - debería ser 2000+
table_definition_cache = 400            # PEQUEÑO - debería ser 1400+
open_files_limit = 5000                 # OK

# === CONFIGURACIÓN DE PERFORMANCE SCHEMA ===
performance_schema = ON
performance_schema_max_table_instances = 12500
performance_schema_max_table_handles = 4000

# Instrumentación para diagnóstico
performance_schema_instrument = 'stage/%=ON'
performance_schema_instrument = 'statement/%=ON'
performance_schema_instrument = 'wait/io/%=ON'

# === CONFIGURACIÓN DE OPTIMIZADOR ===
optimizer_search_depth = 62
optimizer_prune_level = 1
optimizer_switch = 'index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on'

# === CONFIGURACIÓN PROBLEMÁTICA DE TIMEOUTS ===
lock_wait_timeout = 50                  # OK
innodb_lock_wait_timeout = 50           # OK

# === CONFIGURACIÓN DE BINARY LOG ===
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M
sync_binlog = 1                         # SEGURO pero lento

# === CONFIGURACIÓN DE CHARSET ===
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# === CONFIGURACIÓN SQL MODE ===
sql_mode = "STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO"

# === CONFIGURACIÓN DE SEGURIDAD ===
# Configuración permisiva para laboratorio
secure_file_priv = ""
local_infile = 1

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
port = 3306
